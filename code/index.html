



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    
      
        <title>Code - Curve Fit</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#4caf50">
      
    
    
      <script src="../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="green" data-md-color-accent="green">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#map-of-the-code" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Curve Fit" aria-label="Curve Fit" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Curve Fit
            </span>
            <span class="md-header-nav__topic">
              
                Code
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Curve Fit" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Curve Fit
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../methods/" title="Methods" class="md-nav__link">
      Methods
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Code
      </label>
    
    <a href="./" title="Code" class="md-nav__link md-nav__link--active">
      Code
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-model" class="md-nav__link">
    Core Model
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-a-model" class="md-nav__link">
    Setting Up a Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fitting-a-model" class="md-nav__link">
    Fitting a Model
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gaussian-priors" class="md-nav__link">
    Gaussian Priors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constraints" class="md-nav__link">
    Constraints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialization" class="md-nav__link">
    Initialization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimization" class="md-nav__link">
    Optimization
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obtaining-predictions-from-a-model" class="md-nav__link">
    Obtaining Predictions from a Model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-pipelines" class="md-nav__link">
    Model Pipelines
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#predictive-validity" class="md-nav__link">
    Predictive Validity
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../updates/" title="Release Notes" class="md-nav__link">
      Release Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Examples
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Examples
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/get_started_xam/" title="get_started_xam" class="md-nav__link">
      get_started_xam
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/covariate_xam/" title="covariate_xam" class="md-nav__link">
      covariate_xam
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/random_effect_xam/" title="random_effect_xam" class="md-nav__link">
      random_effect_xam
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/sizes_to_indices_xam/" title="sizes_to_indices_xam" class="md-nav__link">
      sizes_to_indices_xam
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/param_time_fun_xam/" title="param_time_fun_xam" class="md-nav__link">
      param_time_fun_xam
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Developer Doc
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Developer Doc
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/unzip_x/" title="unzip_x" class="md-nav__link">
      unzip_x
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/unzip_x_xam/" title="unzip_x_xam" class="md-nav__link">
      unzip_x_xam
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/sizes_to_indices/" title="sizes_to_indices" class="md-nav__link">
      sizes_to_indices
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/split_by_group/" title="split_by_group" class="md-nav__link">
      split_by_group
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/param_time_fun/" title="param_time_fun" class="md-nav__link">
      param_time_fun
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/effects2params/" title="effects2params" class="md-nav__link">
      effects2params
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/objective_fun/" title="objective_fun" class="md-nav__link">
      objective_fun
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/extract_md.py/" title="extract_md.py" class="md-nav__link">
      extract_md.py
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../extract_md/get_cppad_py.py/" title="get_cppad_py.py" class="md-nav__link">
      get_cppad_py.py
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#core-model" class="md-nav__link">
    Core Model
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#setting-up-a-model" class="md-nav__link">
    Setting Up a Model
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#functions" class="md-nav__link">
    Functions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fitting-a-model" class="md-nav__link">
    Fitting a Model
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#gaussian-priors" class="md-nav__link">
    Gaussian Priors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constraints" class="md-nav__link">
    Constraints
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initialization" class="md-nav__link">
    Initialization
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#optimization" class="md-nav__link">
    Optimization
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#obtaining-predictions-from-a-model" class="md-nav__link">
    Obtaining Predictions from a Model
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-pipelines" class="md-nav__link">
    Model Pipelines
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#predictive-validity" class="md-nav__link">
    Predictive Validity
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="map-of-the-code">Map of the Code</h1>
<p>We first start by walking through the <a href="#core-model">core curve fitting model</a>, 
and then the extensions that make
it possible for <code>CurveFit</code> to be used for forecasting 
over time including <a href="#pipelines">pipelines</a> and <a href="#predictive-validity">predictive validity</a>.</p>
<h2 id="core-model">Core Model</h2>
<p><strong><code>curevefit.core</code></strong></p>
<p>Here we will walk through how to use <code>CurveModel</code>.</p>
<p>First, here is an example that you can copy
and paste into your Python interpreter to run start to finish.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">curvefit.core.model</span> <span class="kn">import</span> <span class="n">CurveModel</span>
<span class="kn">from</span> <span class="nn">curvefit.core.functions</span> <span class="kn">import</span> <span class="n">ln_gaussian_cdf</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1234</span><span class="p">)</span>

<span class="c1"># Create example data -- both death rate and log death rate</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;death_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">-</span><span class="mi">20</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="o">-</span><span class="mi">20</span><span class="p">)))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;ln_death_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;death_rate&#39;</span><span class="p">])</span>

<span class="n">df</span><span class="p">[</span><span class="s1">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
<span class="n">df</span><span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Set up the CurveModel</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">CurveModel</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">col_t</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
    <span class="n">col_obs</span><span class="o">=</span><span class="s1">&#39;ln_death_rate&#39;</span><span class="p">,</span>
    <span class="n">col_group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span>
    <span class="n">col_covs</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;intercept&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]],</span>
    <span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">],</span>
    <span class="n">link_fun</span><span class="o">=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">],</span>
    <span class="n">var_link_fun</span><span class="o">=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">],</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">ln_gaussian_cdf</span>
<span class="p">)</span>

<span class="c1"># Fit the model to estimate parameters</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit_params</span><span class="p">(</span><span class="n">fe_init</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">fe_gprior</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">]])</span>

<span class="c1"># Get predictions</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
    <span class="n">group_name</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="p">)</span>

<span class="c1"># Plot results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">df</span><span class="o">.</span><span class="n">ln_death_rate</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
</code></pre></div>


<p>You should see a plot that looks like this:</p>
<p>Now we will walk through each of the steps from above and explain how to use them in detail.</p>
<h3 id="setting-up-a-model">Setting Up a Model</h3>
<p>The code for the core curve fitting model is <code>curvefit.core.model.CurveModel</code>.
To initialize a <code>CurveModel</code>, you need a <code>pandas</code> data frame and information
about what type of model you want to fit. It needs to know which columns
represent what and some model parameters.</p>
<ul>
<li><code>df (pd.DataFrame)</code>: data frame with all available information for the model</li>
<li><code>col_t (str)</code>: the column that indicates the independent variable</li>
<li><code>col_obs (str)</code>: the column that indicates the dependent variable</li>
<li><code>col_covs (list{list{str}})</code>: list of lists of strings that indicate the covariates to use
    for each covariate</li>
<li><code>col_group (str)</code>: the column that indicates the group variable (even if you only have one group
    you must pass a column that indicates group membership)</li>
<li><code>param_names (list{str})</code>: names of the parameters for your specific functional form (more in <a href="#functions">functions</a>)</li>
<li><code>link_fun (list{function})</code>: list of link functions for each of the parameters</li>
<li><code>var_link_fun (list{function})</code>: list of functions for the variables including fixed and random effects</li>
</ul>
<p>First, we create sample data frame where <code>time</code> is the independent variable,
<code>death_rate</code> is the dependent variable, and <code>group</code> is a variable indicating which group an observation belongs to.
In this example, we want to fit to the log erf (also referred to as log Gaussian CDF) functional form (see <a href="#functions">functions</a>) with
identity link functions for each parameter and identity variable link functions for each parameter.
In this example, no parameters have covariates besides an intercept column of 1's.</p>
<div class="codehilite"><pre><span></span><code><span class="n">model</span> <span class="o">=</span> <span class="n">CurveModel</span><span class="p">(</span>
    <span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">,</span>
    <span class="n">col_t</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">,</span>
    <span class="n">col_obs</span><span class="o">=</span><span class="s1">&#39;ln_death_rate&#39;</span><span class="p">,</span>
    <span class="n">col_group</span><span class="o">=</span><span class="s1">&#39;group&#39;</span><span class="p">,</span>
    <span class="n">col_covs</span><span class="o">=</span><span class="p">[[</span><span class="s1">&#39;intercept&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;intercept&#39;</span><span class="p">]],</span>
    <span class="n">param_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;beta&#39;</span><span class="p">,</span> <span class="s1">&#39;p&#39;</span><span class="p">],</span>
    <span class="n">link_fun</span><span class="o">=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">],</span>
    <span class="n">var_link_fun</span><span class="o">=</span><span class="p">[</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">],</span>
    <span class="n">fun</span><span class="o">=</span><span class="n">ln_gaussian_cdf</span>
<span class="p">)</span>
</code></pre></div>


<h3 id="functions">Functions</h3>
<p>The <code>curvefit</code> package has some built-in functions for curves to fit. However, this list is not exhaustive,
and you may pass any callable function that takes in <code>t</code> (an independent variable) and <code>params</code> (a list of parameters)
to the function to the <code>CurveModel</code> class for the <code>fun</code> argument. What you pass in for <code>param_names</code> in the 
<code>CurveModel</code> needs to match what the <code>fun</code> callable expects.</p>
<p>The available built-in functions in <code>curvefit.core.functions</code> are:</p>
<p><strong>The Error Function</strong></p>
<ul>
<li><code>gaussian_cdf</code>: Gaussian cumulative distribution function</li>
<li><code>gaussian_pdf</code>: Gaussian probability distribution function</li>
<li><code>ln_gaussian_cdf</code>: log Gaussian cumulative distribution function</li>
<li><code>ln_gaussian_pdf</code>: log Gaussian probability distribution function</li>
</ul>
<p><strong>The Expit Function</strong> (inverse of the logit function)</p>
<ul>
<li><code>expit</code>: expit function</li>
<li><code>log_expit</code>: log expit function</li>
</ul>
<p>Please see the <a href="../methods/#covid-19-functional-forms">functions</a> for information
about the parametrization of these functions and how they relate to COVID-19 modeling.</p>
<h3 id="fitting-a-model">Fitting a Model</h3>
<p>Once you have a model defined, the method <code>fit_params</code> fits the model. At minimum,
the only information that <code>model.fit_params</code> needs is initial values for the fixed effects.
But there are many optional arguments that you can pass to <code>model.fit_params</code> to inform
the optimization process. Below we describe each of these optional arguments.
The result of <code>fit_params</code> is stored in <code>CurveModel.result</code> and the
parameter estimates in <code>CurveModel.params</code>.</p>
<h4 id="gaussian-priors">Gaussian Priors</h4>
<p><code>fe_gprior</code> and <code>re_gprior</code></p>
<p>Each parameter may have an associated Gaussian prior. This is optional and can be
passed in as a list of lists. This specification, referring to <a href="#setting-up-a-model">our example</a>
will put Gaussian priors with mean 0 and standard deviation 1. on the <code>alpha</code> parameter,
mean 0 and standard deviation 1e-3 on the <code>beta</code> parameter and mean 5 and standard
deviation 10. on the <code>p</code> parameter.</p>
<div class="codehilite"><pre><span></span><code><span class="n">model</span><span class="o">.</span><span class="n">fit_params</span><span class="p">(</span><span class="n">fe_gprior</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mf">10.</span><span class="p">]])</span>
</code></pre></div>


<p>Likewise, you may have random effects Gaussian priors using the argument <code>re_gprior</code>,
which has the same shape as <code>fe_gprior</code>, but refers to the random effects. For the
specifications of fixed and random effects, please see <a href="../methods/#statistical-model">the methods</a>.</p>
<h4 id="constraints">Constraints</h4>
<p><code>fe_bounds</code> and <code>re_bounds</code></p>
<p>You can also include parameter constraints for each of the fixed effects and the
random effects. They are included as a list of lists. This specification,
referring to <a href="#setting-up-a-model">our example</a>, will bound all of the fixed effects
between 0 and 100. and the random effects between -1 and 1.</p>
<div class="codehilite"><pre><span></span><code><span class="n">model</span><span class="o">.</span><span class="n">fit_params</span><span class="p">(</span>
    <span class="n">fe_bounds</span><span class="o">=</span><span class="p">[[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">100.</span><span class="p">]],</span>
    <span class="n">re_bounds</span><span class="o">=</span><span class="p">[[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]]</span>
<span class="p">)</span>
</code></pre></div>


<p>If you do not want to include random effects, set the bounds to be exactly 0. Please
see more information on constraints in <a href="../methods/#constraints">the methods</a>.</p>
<h4 id="initialization">Initialization</h4>
<p>The optimization routine will perform better with smart starting values for the
parameters. Initial values for the fixed effects, <code>fe_init</code>, are required and is passed in as
a <code>numpy</code> array of the same length as your parameters. The initial values for the random
effects, <code>re_init</code>, are passed in as a <code>numpy</code> array ordered by the group name and parameters.</p>
<p>For example, if you had two groups in the model, the following would initialize
the fixed effects at 1., 1., 1., and the random effects at -0.5, -0.5, -0.5, for the first group and
0.5, 0.5, 0.5, for the second group.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">model</span><span class="o">.</span><span class="n">fit_params</span><span class="p">(</span>
    <span class="n">fe_init</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]),</span>
    <span class="n">re_init</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
<span class="p">)</span>
</code></pre></div>


<p>There is an optional flag, <code>smart_initialize</code> that if <code>True</code> will run a model
individually for each group in the model and use their fixed effects estimates
to inform the initial values for both fixed and random effects of the mixed
model that you want to fit.</p>
<h4 id="optimization">Optimization</h4>
<p>The optimization uses <code>scipy.optimize.minimize</code> and the <code>"L-BFGS-B"</code> which has a list of options
that you can pass to it. These keyword options can be passed to the <code>minimize</code> function
using the <code>options</code> argument. For example, the following would perform a maximum
of 500 iterations and require an objective function tolerance of 1e-10.</p>
<div class="codehilite"><pre><span></span><code><span class="n">model</span><span class="o">.</span><span class="n">fit_params</span><span class="p">(</span>
    <span class="n">options</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="mf">1e-10</span><span class="p">,</span>
        <span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">500</span>
    <span class="p">}</span>
<span class="p">)</span>
</code></pre></div>


<p>If you have indicated that you want the model to do smart initialization with
<code>smart_initialize = True</code>, then you can optionally pass a dictionary of <code>smart_init_options</code>
to override the <code>options</code> just for the group-specific initial fits. Otherwise
it will use all of the <code>options</code> in both the group-specific and overall fits.</p>
<p>Please see <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html"><code>scipy.optimize.minimize</code></a>
for more options. Please see <a href="../methods/#optimization-procedure">the methods</a> for more
information about the optimization procedure.</p>
<h3 id="obtaining-predictions-from-a-model">Obtaining Predictions from a Model</h3>
<p>To obtain predictions from a model that has been fit, use the method <code>CurveModel.predict</code>.
The <code>predict</code> function needs to know which values of the independent variable you want
to predict for, which group you want to predict for, and optionally, which space
you want to predict in. For example, you might want to predict in <code>ln_gaussian_cdf</code> space but
make predictions in <code>ln_gaussian_pdf</code> space. This is only possible for functions that are
related to one another (see the <a href="#functions">functions</a> section).</p>
<p>Continuing with <a href="#setting-up-a-model">our example</a>, the following call would
make predictions at all of the times in the original data frame, for group <code>"all"</code>.</p>
<div class="codehilite"><pre><span></span><code><span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span>
    <span class="n">t</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
    <span class="n">group_name</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">group</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="p">)</span>
</code></pre></div>


<h2 id="model-pipelines">Model Pipelines</h2>
<p><strong><code>curvefit.pipelines</code></strong></p>
<p>To customize the modeling process for a specific problem, and integrate the core model with predictive
validity and uncertainty, there is a class <code>curvefit.pipelines._pipeline.ModelPipeline</code> that sets up the structure.
Each file in <code>curvefit.piplelines</code> subclasses this <code>ModelPipeline</code> to have different types of modeling processes.</p>
<p>A <code>ModelPipeline</code> needs to get much of the same information that is passed to <code>CurveModel</code>. The additional
arguments that it needs are</p>
<ul>
<li><code>predict_space (callable)</code>: a <code>curvefit.core.functions</code> function that matches what space
    you want to do predictive validity in</li>
<li><code>all_cov_names (list{str})</code>: a list of all the covariate names that will be used</li>
<li><code>obs_se_func (callable)</code>: in place of <code>col_obs_se</code> we now need to define a function that
    produces the standard error as a function of the independent variable</li>
</ul>
<p>The overall <code>run()</code> method that will be used in <code>ModelPipeline</code> does the following things:</p>
<ul>
<li><code>ModelPipeline.run_init_model()</code>: runs aspects of the model that will not be re-run during
    predictive validity and/or stores information for use later</li>
<li><code>ModelPipeline.run_predictive_validity()</code>: runs predictive validity, described <a href="#predictive-validity">here</a></li>
<li><code>ModelPipeline.fit_residuals()</code>: fits residuals from predictive validity</li>
<li><code>ModelPipeline.create_draws()</code>: creates random realizations of the mean function that for the uncertainty intervals</li>
</ul>
<p>Each subclass of <code>ModelPipeline</code> has different requirements, each of which are described in their
respective docstrings. Available classes and a brief description of what they do are below:</p>
<ul>
<li><code>BasicModel</code>: Runs one model jointly with all groups.</li>
<li><code>BasicModelWithInit</code>: Runs all models separately to do a <a href="#optimization">smart initialization</a> of the
    fixed and random effects, and then runs a joint model with all groups.</li>
<li><code>TightLooseModel</code>: Runs four models with different combinations of settings (one setting should be "tight",
    meaning that it follows the prior closely and one "loose" meaning that it follows the prior less closely)
    and covariate models (can place the covariates on different parameters across models -- by default one is called
    the "beta" model and one is called the "p" model referring to which parameter has covariates). The "tight"
    and "loose" model predictions are blended within each covariate covariate model by using a convex combination
    of the predictions over time. Then the two covariate models are averaged together with pre-specified weights.</li>
<li><code>APModel</code>: Runs group-specific models and introduces a functional prior on the log of the alpha and beta parameters
    for the <code>erf</code> family of functions.</li>
<li><code>PreConditionedAPModel</code>: Runs like an <code>APModel</code> with the <code>erf</code> family but dynamically adjusts the bounds
    for the fixed effects of group-specific models based on preconditioning that flags groups that 
    still have an exponential rise in the dependent variable with respect to the independent variable.</li>
</ul>
<h2 id="predictive-validity">Predictive Validity</h2>
<p><strong><code>curvefit.pv</code></strong></p>
                
                  
                
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../methods/" title="Methods" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Methods
              </span>
            </div>
          </a>
        
        
          <a href="../updates/" title="Release Notes" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Release Notes
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:".."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>